# =================================================
# Unimag Interface
# =================================================

# =================================================
# Aliases for current and voltage
# =================================================

alias("$(P)$(R)CurrentRBV","$(P)$(R)CURRENT_RB")
alias("$(P)$(R)OutputVoltage","$(P)$(R)VOLTAGE_RB")
alias("$(P)$(R)Setpoint","$(P)$(R)CURRENT_SP")


# State calculation
record(calcout, "$(P)$(R)state_calc") {
    field(DESC, "Calculate state from status bits")
    field(SCAN,"1 second")
    field(INPA, "$(P)$(R)SupplyOn")
    field(INPB, "$(P)$(R)GenericFault")
    field(INPC, "$(P)$(R)FETovertemp")
    field(INPD, "$(P)$(R)ShuntOvertemp")
    field(INPE, "$(P)$(R)DCunderV")
    field(INPF, "$(P)$(R)ExternalInterlock1")
    field(CALC, "A=0?0:(F=1?4:(B||C||D||E)?5:1)")
    field(OUT, "$(P)$(R)STATE_RB PP")
    field(OOPT, "Every Time")

}

record(mbbi, "$(P)$(R)STATE_RB") {
    field(DESC, "State readback")
    field(SCAN,"Passive")
    field(ZRVL, "0")
    field(ZRST, "OFF")
    field(ONVL, "1")
    field(ONST, "ON")
    field(TWVL, "2")
    field(TWST, "STANDBY")
    field(THVL, "3")
    field(THST, "RESET")
    field(FRVL, "4")
    field(FRST, "INTERLOCK")
    field(FRSV, "MAJOR") 
    field(FVVL, "5")
    field(FVST, "ERROR")
    field(FVSV, "MAJOR")
    
}

##
## State setpoint
record(mbbo, "$(P)$(R)STATE_SP") {
    field(DESC, "State setpoint")
    field(ZRVL, "0")
    field(ZRST, "OFF")
    field(ONVL, "1")
    field(ONST, "ON")
    field(TWVL, "2")
    field(TWST, "STANDBY")
    field(THVL, "3")
    field(THST, "RESET")
    field(FRVL, "4")
    field(FRST, "INTERLOCK")
    field(FVVL, "5")
    field(FVST, "ERROR")
    field(FLNK, "$(P)$(R)state_to_enable")
}

# Map state to Enable
record(calcout, "$(P)$(R)state_to_enable") {
    field(DESC, "Map state to Enable")
    field(INPA, "$(P)$(R)STATE_SP")
    field(CALC, "A=1?1:(A=2||A==0)?0:1")
    field(OUT, "$(P)$(R)Enable PP")
    field(OOPT, "Every Time")
}

# Map state to Reset
record(calcout, "$(P)$(R)state_to_reset") {
    field(DESC, "Map state to Reset")
    field(INPA, "$(P)$(R)STATE_SP")
    field(CALC, "A=3?1:0")
    field(OUT, "$(P)$(R)Reset PP")
    field(OOPT, "Every Time")
}
